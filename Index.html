<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medi-Al-Shifa Smart Lens POS</title>
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root { --lens-blue: #4285F4; --success-green: #34A853; }
        body { background: #f4f7f6; margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        .main-grid { display: flex; height: 100vh; }

        /* Scanner Styling */
        .scanner-side { flex: 0 0 45%; background: #000; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        .lens-ui {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; height: 80%; border: 3px solid var(--lens-blue);
            border-radius: 20px; box-shadow: 0 0 0 2000px rgba(0,0,0,0.6); z-index: 5;
            transition: all 0.2s ease;
        }
        .lens-ui.active { border-color: var(--success-green); border-width: 5px; }

        .status-msg {
            position: absolute; top: 20px; left: 20px; right: 20px;
            background: rgba(0,0,0,0.8); color: white; padding: 12px;
            border-radius: 10px; text-align: center; font-weight: bold; z-index: 10;
        }

        /* Billing Styling */
        .bill-side { flex: 1; background: white; padding: 30px; display: flex; flex-direction: column; box-shadow: -10px 0 20px rgba(0,0,0,0.1); }
        .table-area { flex: 1; overflow-y: auto; margin-top: 20px; border: 1px solid #eee; border-radius: 12px; }
        
        .summary-bar { 
            background: #1e272e; color: white; padding: 20px; 
            border-radius: 15px; display: flex; justify-content: space-between; align-items: center;
        }
        .total-val { font-size: 36px; font-weight: 800; color: var(--success-green); }

        /* Animation Flash */
        .flash { position: absolute; inset: 0; background: white; opacity: 0; z-index: 10; pointer-events: none; }
        .flash.active { animation: flashAnim 0.3s; }
        @keyframes flashAnim { 0% {opacity: 0;} 50% {opacity: 0.6;} 100% {opacity: 0;} }
    </style>
</head>
<body>

<div class="main-grid">
    <div class="scanner-side">
        <div class="flash" id="flash"></div>
        <div class="status-msg" id="msg">INITIALIZING CAMERA...</div>
        <video id="video" autoplay playsinline></video>
        <div class="lens-ui" id="lens"></div>
    </div>

    <div class="bill-side">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="text-primary m-0">Medi-Al-Shifa</h2>
            <button class="btn btn-sm btn-outline-danger" onclick="location.reload()">Reset POS</button>
        </div>

        <div class="table-area">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Medicine</th>
                        <th>Batch</th>
                        <th>Qty</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="billBody"></tbody>
            </table>
        </div>

        <div class="summary-bar mt-3">
            <span>GRAND TOTAL:</span>
            <span class="total-val" id="grandTotalDisplay">PKR 0.00</span>
        </div>
        <button class="btn btn-success btn-lg w-100 mt-3 shadow" onclick="alert('Sale Finalized!')">FINALIZE SALE</button>
    </div>
</div>

<canvas id="procCanvas" style="display:none;"></canvas>

<script>
    // --- 1. MOCK DATABASE (Aapka SQL Data) ---
    const medicineDB = [
        { id: 1, name: "Panadol 500mg", batchNo: "BN101", mrp: 50.00 },
        { id: 2, name: "Arinac Forte", batchNo: "ART88", mrp: 120.00 },
        { id: 3, name: "Augmentin 625mg", batchNo: "AUG99", mrp: 350.00 },
        { id: 4, name: "Brufen 400mg", batchNo: "BRU44", mrp: 85.00 }
    ];

    const video = document.getElementById('video');
    const msg = document.getElementById('msg');
    const lens = document.getElementById('lens');
    const flash = document.getElementById('flash');
    let worker = null;
    let isProcessing = false;

    // --- 2. CAMERA & AI SETUP ---
    async function init() {
        try {
            msg.innerText = "LOADING AI ENGINE...";
            worker = await Tesseract.createWorker();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
            await worker.setParameters({
                tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-:. ',
                tessedit_pageseg_mode: '1'
            });

            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: { ideal: 1280 } } 
            });
            video.srcObject = stream;
            msg.innerText = "READY: SCAN BATCH NUMBER";
            
            startScanning();
        } catch (err) {
            msg.innerText = "ERROR: " + err.message;
        }
    }

    // --- 3. ADAPTIVE SCANNING LOGIC ---
    async function startScanning() {
        const canvas = document.getElementById('procCanvas');
        const ctx = canvas.getContext('2d');

        while (true) {
            if (isProcessing) { await new Promise(r => setTimeout(r, 100)); continue; }

            // Capture Frame
            canvas.width = 640; canvas.height = 360;
            ctx.filter = 'contrast(200%) grayscale(100%)';
            ctx.drawImage(video, (video.videoWidth-640)/2, (video.videoHeight-360)/2, 640, 360, 0, 0, 640, 360);

            const { data: { text } } = await worker.recognize(canvas);
            const foundBatch = extractBatch(text.toUpperCase());

            if (foundBatch) {
                const medicine = medicineDB.find(m => m.batchNo === foundBatch);
                if (medicine) {
                    isProcessing = true;
                    processSuccess(medicine);
                }
            }
            await new Promise(r => setTimeout(r, 500));
        }
    }

    function extractBatch(text) {
        // Look for BN101, B.NO: ART88, etc.
        const match = text.match(/(?:B\.?NO|BN|BATCH)[:\s]*([A-Z0-9]{3,10})/);
        return match ? match[1] : null;
    }

    // --- 4. UI UPDATES ---
    function processSuccess(med) {
        // Feedback
        flash.classList.add('active');
        lens.classList.add('active');
        msg.innerText = "MATCH FOUND: " + med.name;
        
        // Add to Table
        const tbody = document.getElementById('billBody');
        let row = document.querySelector(`tr[data-id="${med.id}"]`);
        
        if (row) {
            let qty = parseInt(row.cells[2].innerText) + 1;
            row.cells[2].innerText = qty;
            row.cells[3].innerText = (qty * med.mrp).toFixed(2);
        } else {
            const html = `
                <tr data-id="${med.id}">
                    <td><strong>${med.name}</strong></td>
                    <td><span class="badge bg-secondary">${med.batchNo}</span></td>
                    <td>1</td>
                    <td>${med.mrp.toFixed(2)}</td>
                    <td><button class="btn btn-sm btn-link text-danger" onclick="this.closest('tr').remove(); updateTotal();">âœ•</button></td>
                </tr>`;
            tbody.insertAdjacentHTML('afterbegin', html);
        }

        updateTotal();

        setTimeout(() => {
            flash.classList.remove('active');
            lens.classList.remove('active');
            isProcessing = false;
            msg.innerText = "READY: SCAN NEXT";
        }, 2000);
    }

    function updateTotal() {
        let total = 0;
        document.querySelectorAll('#billBody tr').forEach(row => {
            total += parseFloat(row.cells[3].innerText);
        });
        document.getElementById('grandTotalDisplay').innerText = "PKR " + total.toFixed(2);
    }

    init();
</script>

</body>
</html>
